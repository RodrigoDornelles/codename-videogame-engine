<!DOCTYPE html>
<html lang="en">
  <head>
    <title>{{title}} - {{version}}</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta name="theme-color" content="#000000"/>
    <meta name="description" content="{{description}}"/>
    <meta property="og:type" content="website" />
    <meta property="og:title" content="{{title}}" />
    <meta property="og:description" content="{{description}}"/>
    <meta property="twitter:title" content="{{title}}" />
    <meta property="twitter:description" content="{{description}}" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <style>
        *, *::after, *::before {
            touch-action: none;
            box-sizing: border-box;
            border: 0;
            padding: 0;
            margin: 0;
        }
        body {
            height: 99.998vh;
            display: flex;
            overflow: hidden;
            justify-content: center;
            align-items: start;
            background-color: gray;
        }
        canvas {
            image-rendering: pixelated;
        }
    </style>
  </head>
  <body>
    <main>
      <canvas id="gameCanvas"></canvas>
    </main>
    <script src="engine.js"></script>
    <script type="module">
      import { LuaFactory, LuaMultiReturn } from 'https://cdn.jsdelivr.net/npm/wasmoon@1.16.0/+esm'

      document.addEventListener('DOMContentLoaded', async () => {
        const factory = new LuaFactory()
        const lua = await factory.createEngine()
        const engine_response = await fetch('./main.lua')
        const game_response = await fetch('./game.lua')
        const engine_lua = await engine_response.text()
        const game_lua = await game_response.text()
        const engine = await lua.doString(engine_lua)
        
        gly.global.set('native_callback_init', lua.global.get('native_callback_init'))
        gly.global.set('native_callback_loop', lua.global.get('native_callback_loop'))
        gly.global.set('native_callback_draw', lua.global.get('native_callback_draw'))
        gly.global.set('native_callback_resize', lua.global.get('native_callback_resize'))
        gly.global.set('native_callback_keyboard', lua.global.get('native_callback_keyboard'))
        lua.global.set('native_draw_start', gly.global.get('native_draw_start'))
        lua.global.set('native_draw_flush', gly.global.get('native_draw_flush'))
        lua.global.set('native_draw_clear', gly.global.get('native_draw_clear'))
        lua.global.set('native_draw_color', gly.global.get('native_draw_color'))
        lua.global.set('native_draw_font', gly.global.get('native_draw_font'))
        lua.global.set('native_draw_rect', gly.global.get('native_draw_rect'))
        lua.global.set('native_draw_line', gly.global.get('native_draw_line'))
        lua.global.set('native_draw_image', gly.global.get('native_draw_image'))
        lua.global.set('native_dict_http', gly.global.get('native_dict_http'))
        lua.global.set('native_dict_json', gly.global.get('native_dict_json'))
        lua.global.set('native_dict_poly', gly.global.get('native_dict_poly'))
        lua.global.set('native_draw_text', (x, y, text) => {
          const native_draw_text = gly.global.get('native_draw_text')
          return LuaMultiReturn.from(native_draw_text(x, y, text))
        })

        gly.error('stop, canvas, console')
        gly.init('#gameCanvas')
        gly.load(game_lua)

        const keys = [
          [403, 'red'],
          [404, 'green'],
          [405, 'yellow'],
          [406, 'blue'],
          ['KeyZ', 'red'],
          ['KeyX', 'green'],
          ['KeyC', 'yellow'],
          ['KeyV', 'blue'],
          ['Enter', 'enter'],
          ['ArrowUp', 'up'],
          ['ArrowDown', 'down'],
          ['ArrowLeft', 'left'],
          ['ArrowRight', 'right'],
        ];

        function updateSize() {
          gly.resize()
        }

        function updateKey(ev) {
          const key = keys.find(key => key[0] == ev.code)
          if (key) {
            gly.input(key[1], Number(ev.type === 'keydown'))
          }
        }
  
        function updateLoop() {
          window.requestAnimationFrame(updateLoop);
          gly.update((new Date()).getTime())
        }

        window.addEventListener("resize", updateSize);
        window.addEventListener('keydown', updateKey)
        window.addEventListener('keyup', updateKey)
        window.requestAnimationFrame(updateLoop);
      })
    </script>
  </body>
</html>
